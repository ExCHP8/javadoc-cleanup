# javadoc-cleanup

[![GitHub release (latest by date)](https://img.shields.io/github/v/release/cicirello/javadoc-cleanup?label=Marketplace&logo=GitHub)](https://github.com/marketplace/actions/javadoc-cleanup)
[![build](https://github.com/cicirello/javadoc-cleanup/workflows/build/badge.svg)](https://github.com/cicirello/javadoc-cleanup/actions?query=workflow%3Abuild)
[![GitHub](https://img.shields.io/github/license/cicirello/javadoc-cleanup)](https://github.com/cicirello/javadoc-cleanup/blob/master/LICENSE)
![GitHub top language](https://img.shields.io/github/languages/top/cicirello/javadoc-cleanup)

The javadoc-cleanup GitHub action is a utility to tidy up javadocs prior to deployment to 
an API documentation website, assumed hosted on GitHub Pages. It performs the following
functions:
* Improves mobile browsing experience: It inserts `<meta name="viewport" content="width=device-width, initial-scale=1">` within the `<head>` of each html file that was generated by javadoc.
* Strips out any timestamps inserted by javadoc: The timestamps cause a variety of version control issues for documentation sites maintained in git repositories. Javadoc has an option `-notimestamp` to direct javadoc not to insert timestamps (which we recommend that you also use). However, at the present time there appears to be a bug (in OpenJDK 11's javadoc, and possibly other versions), where the timestamp is not ommitted in the `overview-summary.html` generated by javadoc.

The javadoc-cleanup GitHub action is designed to be used 
in combination with other GitHub Actions. For example, it 
does not commit and push the modified javadocs. See 
the [Examples](#examples) for examples of combining
with other actions in your workflow.

## Inputs

### `path-to-root`

**Required** The path to the root of the website relative to the
root of the repository. The default is `.` which 
is appropriate in cases where you are using a `gh-pages` branch
for your documentation site. If you are instead using this for a GitHub Pages site
in the `docs` directory, then
just pass `docs` for this input.

### `base-url-path`

**Optional** This is the url to your website. It is currently unused by the GitHub
action (it is reserved for planned future functionality).  It defaults
to an empty string.

## Outputs

### `modified-count`

This output is the count of the number of html pages modified by the action.

## Examples

### Example 1: Basic example

This example workflow is triggered by a push of java source files.
After setting up java, an ant script is first used to generate the javadocs.  You can find
an [example ant build file](https://github.com/cicirello/Chips-n-Salsa/blob/master/build/builddocs.xml) 
for just generating javadocs in a repository that
is currently using the javadoc-cleanup action.  After which,
the javadoc-cleanup action runs. The workflow then outputs the number of modified
html pages (for logging purposes). The workflow then commits the changes (if any).
Before committing the changes, the workflow checks whether any html files differ
from what is currently in the repository.  The reason for this check is that the
example workflow is using Java 11's javadoc, which generates a few zip files containing
a search index. Due to time-stamping, those zip files will always differ with each javadoc
run. That check in this example workflow is a bit of a hack to avoid unnecessarily 
repeatedly committing the javadoc site search index.  This example doesn't push the changes,
but you can easily add a `git push` after the commit, or add another action to handle
that.

```yml
name: docs

on:
  push:
    branches: [ master ]
    paths: [ '**.java' ]

jobs:
  api-website:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout the repo
      uses: actions/checkout@v2

    - name: Set up JDK 1.11
      uses: actions/setup-java@v1
      with:
        java-version: 1.11
    
    - name: Clean docs
      run: ant -noinput -buildfile build/builddocs.xml clean

    - name: Build docs with Ant
      run: ant -noinput -buildfile build/builddocs.xml
    
    - name: Tidy up the javadocs
      id: tidy
      uses: cicirello/javadoc-cleanup@v1.1.0
      with:
        path-to-root: docs
    
    - name: Log javadoc-cleanup output
      run: |
        echo "modified-count = ${{ steps.tidy.outputs.modified-count }}"
    
    - name: Commit documentation changes
      run: |
        if [ $(git status | grep -c "**/*.html") == "0" ]; then
          git checkout .
        else
          git config --global user.name 'Your Name'
          git config --global user.email 'YOUR-USERNAME@users.noreply.github.com'
          git add -A
          git commit -m "Automated API website updates."
        fi
```

### Example 2: Combining with other GitHub actions

This example combines the `javadoc-cleanup` action with other actions. Specifically,
it uses the [cicirello/generate-sitemap](https://github.com/cicirello/generate-sitemap) action 
to generate a sitemap for the documentation website, and the 
[peter-evans/create-pull-request](https://github.com/peter-evans/create-pull-request)
action to create a pull request with the changes.  Note that for this example,
the checkout action is called with `fetch-depth: 0` because `generate-sitemap` needs
to complete commit history. This is unnecessary for usage of the `javadoc-cleanup` action
alone.

```yml
name: docs

on:
  push:
    branches: [ master ]
    paths: [ '**.java' ]

jobs:
  api-website:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout the repo
      uses: actions/checkout@v2
      with:
        fetch-depth: 0 

    - name: Set up JDK 1.11
      uses: actions/setup-java@v1
      with:
        java-version: 1.11
    
    - name: Clean docs
      run: ant -noinput -buildfile build/builddocs.xml clean

    - name: Build docs with Ant
      run: ant -noinput -buildfile build/builddocs.xml
    
    - name: Tidy up the javadocs
      id: tidy
      uses: cicirello/javadoc-cleanup@v1.1.0
      with:
        path-to-root: docs
    
    - name: Log javadoc-cleanup output
      run: |
        echo "modified-count = ${{ steps.tidy.outputs.modified-count }}"
    
    - name: Commit documentation changes
      run: |
        if [ $(git status | grep -c "**/*.html") == "0" ]; then
          git checkout .
        else
          git config --global user.name 'Your Name'
          git config --global user.email 'YOUR-USERNAME@users.noreply.github.com'
          git add -A
          git commit -m "Automated API website updates."
        fi

    - name: Generate the sitemap
      id: sitemap
      uses: cicirello/generate-sitemap@v1.6.1
      with:
        base-url-path: https://URL.FOR.YOUR.WEBSITE.GOES.HERE/
        path-to-root: docs
        
    - name: Create Pull Request
      uses: peter-evans/create-pull-request@v3.4.0
      with:
        title: "Automated API website updates."
        commit-message: "Automated API documentation website updates."
```

## License

The scripts and documentation for this GitHub action are released under
the [MIT License](https://github.com/cicirello/javadoc-cleanup/blob/master/LICENSE).
