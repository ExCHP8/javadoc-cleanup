# javadoc-cleanup

[![GitHub release (latest by date)](https://img.shields.io/github/v/release/cicirello/javadoc-cleanup?label=Marketplace&logo=GitHub)](https://github.com/marketplace/actions/javadoc-cleanup)
[![build](https://github.com/cicirello/javadoc-cleanup/workflows/build/badge.svg)](https://github.com/cicirello/javadoc-cleanup/actions?query=workflow%3Abuild)
[![GitHub](https://img.shields.io/github/license/cicirello/javadoc-cleanup)](https://github.com/cicirello/javadoc-cleanup/blob/master/LICENSE)
![GitHub top language](https://img.shields.io/github/languages/top/cicirello/javadoc-cleanup)

The javadoc-cleanup GitHub action is a utility to tidy up javadocs prior to deployment to 
an API documentation website, assumed hosted on GitHub Pages. It performs the following
functions:
* Improves mobile browsing experience: It inserts `<meta name="viewport" content="width=device-width, initial-scale=1">` within the `<head>` of each html file that was generated by javadoc.
* Strips out any timestamps inserted by javadoc: The timestamps cause a variety of version control issues for documentation sites maintained in git repositories. Javadoc has an option `-notimestamp` to direct javadoc not to insert timestamps (which we recommend that you also use). However, at the present time there appears to be a bug (in OpenJDK 11's javadoc, and possibly other versions), where the timestamp is not ommitted in the `overview-summary.html` generated by javadoc.
* Optionally, it is also capable of generating and inserting the canonical URL for each page, of the form `<link rel="canonical" href="https://URL.TO.YOUR.API.DOC.WEBSITE/page.html">`.

The javadoc-cleanup GitHub action is designed to be used 
in combination with other GitHub Actions. For example, it 
does not commit and push the modified javadocs. See 
the [Examples](#examples) for examples of combining
with other actions in your workflow.

## Inputs

### `path-to-root`

**Required** The path to the root of the website relative to the
root of the repository. The default is `.` which 
is appropriate in cases where you are using a `gh-pages` branch
for your documentation site. If you are instead using this for a GitHub Pages site
in the `docs` directory, then
just pass `docs` for this input.

### `base-url-path`

**Optional** This is the url to the root of your website. If you provide this input, then javadoc-cleanup will generate and insert a canonical link for each page in the header, of the form: `<link rel="canonical" href="https://URL.TO.YOUR.API.DOC.WEBSITE/page.html">`, assuming `base-url-path` equals `"https://URL.TO.YOUR.API.DOC.WEBSITE/"` and assume `page.html` is the relevant filename.

## Outputs

### `modified-count`

This output is the count of the number of html pages modified by the action.

## Examples

### Example 1: Basic example without canonical links

This example workflow is triggered by a push of java source files.
After setting up java, Maven is used to generate the javadocs, and 
the javadocs are then copied from Maven default target location to the 
docs directory where the GitHub Pages documentation site is assumed hosted. This 
example assumes you have Maven's `target` directory in your `.gitignore`.
After which, the javadoc-cleanup action runs. The workflow then outputs 
the number of modified html pages (for logging purposes). The 
workflow then commits the changes (if any).
Before committing the changes, the workflow checks whether any html files differ
from what is currently in the repository.  The reason for this check is that the
example workflow is using Java 11's javadoc, which generates a few zip files containing
a search index. Due to time-stamping, those zip files will always appear 
different to git with each javadoc
run. That check in this example workflow is a bit of a hack to avoid unnecessarily 
repeatedly committing the javadoc site search index.  This example doesn't push the changes,
but you can easily add a `git push` after the commit, or add another action to handle
that.

```yml
name: docs

on:
  push:
    branches: [ master ]
    paths: [ '**.java' ]

jobs:
  api-website:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout the repo
      uses: actions/checkout@v2

    - name: Set up the Java JDK
      uses: actions/setup-java@v2
      with:
        java-version: '11'
        distribution: 'adopt'

    - name: Build docs with Maven
      run: mvn javadoc:javadoc

    - name: Copy to Documentation Website Location
      run: |
        rm -rf docs
        cp -rf target/site/apidocs/. docs

    - name: Tidy up the javadocs
      id: tidy
      uses: cicirello/javadoc-cleanup@v1.2.0
      with:
        path-to-root: docs
    
    - name: Log javadoc-cleanup output
      run: |
        echo "modified-count = ${{ steps.tidy.outputs.modified-count }}"
    
    - name: Commit documentation changes
      run: |
        if [ $(git status | grep -c "**/*.html") == "0" ]; then
          git checkout .
        else
          git config --global user.name 'Your Name'
          git config --global user.email 'YOUR-USERNAME@users.noreply.github.com'
          git add -A
          git commit -m "Automated API website updates."
        fi
```

### Example 2: Basic example with canonical links

This example workflow is mostly the same as above, except it also 
generates and inserts canonical links in each javadoc page.

```yml
name: docs

on:
  push:
    branches: [ master ]
    paths: [ '**.java' ]

jobs:
  api-website:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout the repo
      uses: actions/checkout@v2

    - name: Set up the Java JDK
      uses: actions/setup-java@v2
      with:
        java-version: '11'
        distribution: 'adopt'

    - name: Build docs with Maven
      run: mvn javadoc:javadoc

    - name: Copy to Documentation Website Location
      run: |
        rm -rf docs
        cp -rf target/site/apidocs/. docs

    - name: Tidy up the javadocs
      id: tidy
      uses: cicirello/javadoc-cleanup@v1.2.0
      with:
        base-url-path: https://URL.FOR.YOUR.WEBSITE.GOES.HERE/
        path-to-root: docs
    
    - name: Log javadoc-cleanup output
      run: |
        echo "modified-count = ${{ steps.tidy.outputs.modified-count }}"
    
    - name: Commit documentation changes
      run: |
        if [ $(git status | grep -c "**/*.html") == "0" ]; then
          git checkout .
        else
          git config --global user.name 'Your Name'
          git config --global user.email 'YOUR-USERNAME@users.noreply.github.com'
          git add -A
          git commit -m "Automated API website updates."
        fi
```


### Example 3: Combining with other GitHub actions

This example combines the `javadoc-cleanup` action with other actions. Specifically,
it uses the [cicirello/generate-sitemap](https://github.com/cicirello/generate-sitemap) action 
to generate a sitemap for the documentation website, and the 
[peter-evans/create-pull-request](https://github.com/peter-evans/create-pull-request)
action to create a pull request with the changes.  Note that for this example,
the checkout action is called with `fetch-depth: 0` because `generate-sitemap` needs
the complete commit history. This is unnecessary for usage of the `javadoc-cleanup` action
alone.

```yml
name: docs

on:
  push:
    branches: [ master ]
    paths: [ '**.java' ]

jobs:
  api-website:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout the repo
      uses: actions/checkout@v2
      with:
        fetch-depth: 0 

    - name: Set up the Java JDK
      uses: actions/setup-java@v2
      with:
        java-version: '11'
        distribution: 'adopt'
    
    - name: Build docs with Maven
      run: mvn javadoc:javadoc

    - name: Copy to Documentation Website Location
      run: |
        rm -rf docs
        cp -rf target/site/apidocs/. docs
    
    - name: Tidy up the javadocs
      id: tidy
      uses: cicirello/javadoc-cleanup@v1.2.0
      with:
        path-to-root: docs
        base-url-path: https://URL.FOR.YOUR.WEBSITE.GOES.HERE/
    
    - name: Log javadoc-cleanup output
      run: |
        echo "modified-count = ${{ steps.tidy.outputs.modified-count }}"
    
    - name: Commit documentation changes
      run: |
        if [ $(git status | grep -c "**/*.html") == "0" ]; then
          git checkout .
        else
          git config --global user.name 'Your Name'
          git config --global user.email 'YOUR-USERNAME@users.noreply.github.com'
          git add -A
          git commit -m "Automated API website updates."
        fi

    - name: Generate the sitemap
      id: sitemap
      uses: cicirello/generate-sitemap@v1.6.1
      with:
        base-url-path: https://URL.FOR.YOUR.WEBSITE.GOES.HERE/
        path-to-root: docs
        
    - name: Create Pull Request
      uses: peter-evans/create-pull-request@v3.4.0
      with:
        title: "Automated API website updates."
        commit-message: "Automated API documentation website updates."
```

## License

The scripts and documentation for this GitHub action are released under
the [MIT License](https://github.com/cicirello/javadoc-cleanup/blob/master/LICENSE).
